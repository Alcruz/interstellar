\section{Linear complementary problem}


Now, note that the bound of $V(S, t)$ in each region is
\begin{align*}
  &V(S, t) - H(S, t) > 0 \qquad \text{for all $(S,t) \in \mathcal{C}$} \\ 
  &V(S, t) - H(S, t) = 0 \qquad \text{for all $(S,t) \in \mathcal{S}$}
\end{align*}

Similarly, the bound of $\mathcal{L}_{\text{BS}}(V)$ is
\begin{align*}
  &\frac{\partial{V}}{\partial{t}} + \frac{1}{2}\sigma^{2} S^2 \frac{\partial^2{V}}{\partial{S^2}} + (r - \delta)S \frac{\partial{V}}{\partial{S}} - rV = 0 \qquad \text{for $(S,t) \in \mathcal{C}$} \\
  &\frac{\partial{V}}{\partial{t}} + \frac{1}{2}\sigma^{2} S^2 \frac{\partial^2{V}}{\partial{S^2}} + (r - \delta)S \frac{\partial{V}}{\partial{S}} - rV < 0 \qquad \text{for $(S,t) \in \mathcal{S}$}
\end{align*}

Therefore, grouping the bounds above we form a linear complementary system of equations
{
  \color{red}  
  \begin{align}
    \begin{cases}
      \big[\frac{\partial V}{\partial t} - \mathcal{L}_{\text{BS}}(V)\big] \cdot [V(S,t) - H(S,t)] = 0 & \text{for all $(S,t)$} \\
      V(S, t) - H(S, t) \ge 0 & \text{for all $(S, t)$}\\
      \frac{\partial V}{\partial t} - \mathcal{L}_{\text{BS}}(V) \le 0 &  \text{for all $(S, t)$}\\
      V(S, T) = H(S, T) \\  
    \end{cases}
    \label{eq:background:finance:linear_complementary_problem}
  \end{align}
}

The benefit of the reformulation (\ref*{eq:background:finance:linear_complementary_problem})
is that there is no dependence on the unknown boundary of the continuation region.
Later in section (XXX) and section (XXX), we will explore numerical methods for solving 
both type of problems.



The Black-Scholes PDE can be transformed to heat diffusion PDE using the following
change of variables

\begin{align*}
  S &= Ke^x \\
  t &= T - \dfrac{2\tau}{\sigma^2} \\ 
  q &:= \dfrac{2r}{\sigma^2} \\
  q_{\delta} &:= \dfrac{2(r-\delta)}{\sigma^2} \\
  \alpha &:= \dfrac{1}{2}(q_{\delta} - 1) \\
  \beta &:= \dfrac{1}{4}(q_{\delta} - 1)^2 + q \\
  v(x, \tau) &:= e^{-(\alpha x + \beta \tau)}y(x, \tau)= V(S, t)
\end{align*}

The system (\ref{eq:background:finance:free_boundary_problem}) 
is the free boundary formulation for the pricing problem for American options.
A detailed derivation of (\ref{eq:background:finance:american_options_pde}) 
can be found at [REFERENCES].


The equation (\ref*{eq:background:finance:american_options_pde}) 
is a paraboblic PDE. Moreover, by applying the transformation,


the equation (\ref*{eq:background:finance:american_options_pde}) converts 
to the heat diffusion PDE.

\begin{equation}
  h(x, \tau) := \dfrac{H(S, t)}{K} = \begin{cases}
    \max(e^{x} - 1, 0)\\
    \max(1 - e^{x}, 0)
  \end{cases} 
\end{equation}

\begin{equation}
  \bar{x}(\tau) := \log{\bar{S}(t)} - \log{K} 
\end{equation}

\begin{align}
  \begin{cases}
    \dfrac{\partial y}{\partial \tau} = \dfrac{\partial^2 y}{\partial x^2} & \text{for $\tau\in[0,\dfrac{\sigma^2}{2}T)$ and $x\in(\bar{x}(t), \infty)$} \\
    y(x, \tau) = e^{(\alpha x + \beta \tau)}h(x, \tau) & \text{for $\tau\in[0, \dfrac{\sigma^2}{2}T]$ and $x\in(-\infty, \bar{x}(\tau)]$} \\
    \bar{x}(0) = 0
  \end{cases}
  \label{eq:background:finance:american_option_heat_equation}
\end{align}

We can reformulate equation (\ref*{eq:background:finance:american_option_heat_equation})
as:

\begin{equation}
  g := e^{\alpha x + \beta \tau}h(x, \tau)
\end{equation}

\begin{align}
  \begin{cases}
    \big(\dfrac{\partial y}{\partial \tau} - \dfrac{\partial^2 y}{\partial x^2}\big)(y  - g) =0 \\
    \dfrac{\partial y}{\partial \tau} - \dfrac{\partial^2 y}{\partial x^2} \ge 0 \quad y - g \ge 0 \\
    y(x, 0) = g(x, 0)
  \end{cases}
\end{align}


By exploring the geometric properties of the value function $V(S,t)$, 
we can determine useful conditions that will later help on in solving the equation 
(\ref*{eq:background:finance:american_options_pde}). Firstly, at
any given time $0 \le t \le T$, American options match the linear segment of the payoff
function within the stopping region. Therefore, we could say that 

\begin{align}
  \dfrac{\partial V}{\partial S}(S, t) =  \begin{cases}
    -1 & \text{(put)} \\ 
    1 & \text{(call)}
  \end{cases}
  \label{eq:background:finance:american_option_left_boundary}
\end{align}

Moreover, as the price goes to infinity the value of the option tends to zero

\begin{align}
  \lim_{S \rightarrow \infty}V(S, t) = 0 
  \label{eq:background:finance:american_option_stopping_right_boundary}
\end{align}



Pricing American options requires using numerical methods. The Black-Scholes PDE 
in (XXX) can be converted to the heat diffusion equation



To obtain such approximation, we rely on central difference approximations (REFERENCE).



\subsection{Explicit scheme}

An explicit scheme is one where we approximate the time partial derivative using
a forward difference approximation. Hence, the PDE in (XXX) is approximated as

\begin{equation}
  \dfrac{y^{n+1}_{i} - y^{n}_{i}}{\Delta \tau} = \dfrac{y^{n}_{i-1} - 2y^{n}_{i} + y^{n}_{i+1}}{(\Delta x)^2}
\end{equation}

By rearranging the terms,

\begin{equation}
  \lambda := \dfrac{\Delta \tau}{(\Delta x)^2}
\end{equation}

\begin{equation}
  y^{n+1}_i = \lambda y^{n}_{i-1} + (1 - 2\lambda)y^{n}_{i} + \lambda y^{n}_{i+1}
\end{equation}

It is shown by reference [REFERENCE] that method (XXX) is stable and consistent 
under the following condition

\begin{equation}
  0 < \Delta \tau \le \dfrac{(\Delta x)^2}{2}
\end{equation}

Moreover, the method has order of convergence $O(\Delta \tau, (\Delta x)^{2})$.

\subsection{Implicit scheme}

The implicit scheme approximates the time derivative using a backward difference

\begin{equation}
  \dfrac{y^{n+1}_{i} - y^{n}_{i}}{\Delta \tau} = \dfrac{y^{n+1}_{i-1} - 2y^{n+1}_{i} + y^{n+1}_{i+1}}{(\Delta x)^2}
\end{equation}

\begin{equation}
  y^{n+1}_{i} - \lambda (y^{n+1}_{i-1} - 2y^{n+1}_{i} + y^{n+1}_{i+1}) = y^{n}_{i}  
\end{equation}

\begin{equation}
  K := \begin{bmatrix}
    2 & -1     & & 0 \\ 
   -1 & \ddots & \ddots \\
      & \ddots & \ddots & \ddots \\
    0 & & \ddots & \ddots & \\
  \end{bmatrix} 
\end{equation}

\begin{equation}
  (I + \lambda K)\boldsymbol{y}^{n+1} = \boldsymbol{y}^{n}
\end{equation}

\subsection{Theta method}

\begin{equation}
  \dfrac{y^{n+1}_{i} - y^{n}_{i}}{\Delta \tau} = (1-\theta)\dfrac{y^{n}_{i-1} - 2y^{n}_{i} + y^{n}_{i+1}}{(\Delta x)^2} +  \theta\dfrac{y^{n+1}_{i-1} - 2y^{n+1}_{i} + y^{n+1}_{i+1}}{(\Delta x)^2}
\end{equation}

\begin{equation}
  y^{n+1}_{i} - \lambda\theta(y^{n+1}_{i-1} - 2y^{n+1}_{i} + y^{n+1}_{i+1}) =  y^{n}_{i} + (1-\theta)\lambda(y^{n}_{i-1} - 2y^{n}_{i} + y^{n}_{i+1})
\end{equation}

\begin{equation}
  (1 + \lambda\theta K)\boldsymbol{y}^{n+1} = (1-\lambda\theta K)\boldsymbol{y}^{n} 
\end{equation}

\subsubsection{Theta method}

We discretize the system of equation containing (3.17) and (3.18) to solve it. 
Firstly, we define an uniform meshgrid within the region $[1, x_\text{max}]\times [0, T]$ and 
with resolution $\Delta x$ and $\Delta t$.

\begin{align*}
    M := \dfrac{x_{\text{max}} - 1}{\Delta x}
    \qquad
    N := \dfrac{T}{\Delta t}
\end{align*}

\begin{align*}
   & & x_i &:= 1 + i{\Delta x} &\text{for $i = 0,\dots,M$} & & \\ 
   & & t_n &:= n{\Delta t} &\text{for $n = 0,\dots,N$} & &
\end{align*}

Now we define the approximations

\begin{equation}
    v^{n}_{i} \approx v(x_{i}, t_{n}) \qquad \text{for $(x_{i}, t_{n}) \in \{x_k\}^{M}_{0} \times \{t_k\}^{N}_{0}$} 
\end{equation}
\begin{equation}
    \bar{S}^{n} \approx \bar{S}(t_{n}) \qquad \text{for $t_{n} \in \{t_k\}^{N}_{0}$} 
\end{equation}

By the boundary conditions, we can derive an expression for

\begin{align}
    v^{n}_{0} &= K - \bar{S}^{n} \qquad \text{for $n = 0, \dots, N - 1, N$} \\
    v^{n}_{M+1} &= 0 \qquad \text{for $n = 0, \dots, N - 1, N$}
\end{align}

Additionally by using the smothness condition, we get:

\begin{align}
    \dfrac{v^{n}_{1} - v^{n}_0}{\Delta x} = -\bar{S}^{n}
\end{align}

or 

\begin{align}
    v^{n}_{1}= K - (1 + {\Delta x})\bar{S}^{n}
\end{align}

Next, we equation (3.XX) discretize using centered finite difference. The discretization
method, we use is the theta method which a interpolation between an implicit and explicit scheme.

\begin{equation}
    \begin{split}
        v^{t+1}_{i} &- v^{t}_{i} + \theta \bigg\{ \dfrac{1}{2}\sigma^2 x^{2}_{i} \dfrac{\Delta t}{(\Delta x)^2} (v^{t}_{i-1} - 2 v^{t}_{i} + v^{t}_{i+1}) + \bigg[ (r - \delta) - \dfrac{1}{\bar{S}^t} \dfrac{\bar{S}^{t+1} - \bar{S}^{t}}{\Delta t} \bigg] \dfrac{\Delta t}{2\Delta x} (v_{i+1}^{t} - v_{i-1}^{t}) - r v^{t}_{i} \Delta t \bigg\}
        \\ & + (1-\theta) \bigg\{ \dfrac{1}{2}\sigma^2 x^{2}_{i} \dfrac{\Delta t}{(\Delta x)^2}(v^{t+1}_{i-1} - 2 v^{t+1}_{i} + v^{t+1}_{i+1}) 
        \\ &  + \bigg[ (r - \delta) - \dfrac{1}{\bar{S}^{t+1}} \dfrac{\bar{S}^{t+1} - \bar{S}^{t}}{\Delta t} \bigg]\dfrac{\Delta t}{2\Delta x}(v_{i+1}^{t+1} - v_{i-1}^{t+1}) - r v^{t+1}_{i} \Delta t \bigg\} = 0
    \end{split}
\end{equation}

To simplify the expression above, we introduce the following terms

\begin{equation}
    \lambda := \dfrac{\Delta t}{(\Delta x)^2}
\end{equation}

\begin{align}
    \alpha_i &:= 1 + \theta (\lambda \sigma^2 x_{i}^{2} + r{\Delta t}) \\
    \beta_i &:= - \dfrac{1}{2} \lambda \theta \bigg[ \sigma^{2} x_{i}^{2} - x_i \Delta x (r - \delta) \bigg]  - \dfrac{1}{2} \lambda \theta   x_i \Delta x \dfrac{\bar{S}^{n+1} - \bar{S}^{n}}{\Delta t \bar{S}^n}  \\
    \gamma_i &:= -\dfrac{1}{2} \lambda \theta \bigg[ \sigma^{2} x_{i}^{2} + x_i \Delta x (r - \delta) \bigg]  + \dfrac{1}{2} \lambda \theta  x_i \Delta x  \dfrac{\bar{S}^{n+1} - \bar{S}^{n}}{\Delta t \bar{S}^n}\\
    a_i &:= 1 - (1-\theta) (\lambda \sigma^2 x_{i}^{2} +  r{\Delta t}) \\
    b_i &:= \dfrac{1}{2} (1-\theta) \lambda \bigg[\sigma^{2} x_{i}^{2} - x_i \Delta x \bigg( (r - \delta) - \dfrac{1}{\Delta t} \bigg) \bigg] \\
    c_i &:= \dfrac{1}{2} (1-\theta) \lambda \bigg[ \sigma^{2} x_{i}^{2} +  x_i \Delta x \bigg( (r - \delta) - \dfrac{1}{\Delta t} \bigg) \bigg] \\
    d^{n+1}_i &:= (1-\theta) \dfrac{x_i}{2 \Delta x}  \dfrac{v^{n+1}_{i+1} - v^{n+1}_{i-1}}{\bar{S}^{n+1}}
\end{align}

Now, the expression above becomes

\begin{equation}
    \beta^{n}_{i} v^{n}_{i-1} + \alpha^{n}_{i} v^{n}_{i} + \gamma^{n}_{i} v^{n}_{i+1} = b_i v^{n+1}_{i-1} + a_i v^{n+1}_{i} + c_i v^{n+1}_{i+1} + d^{n+1}_{i}\bar{S}^{n}
\end{equation}

\begin{align}
    \gamma^{n}_{1} v^{n}_{2} = b_1 v^{n+1}_{0} + a_1 v^{n+1}_{1} + c_1 v^{n+1}_{2} + d^{n+1}_{1}\bar{S}^{n} - \beta^{n}_{1} (K - \bar{S}^n) - \alpha^{n}_{1} (K - (1+\Delta x)\bar{S}^n) 
\end{align}

\begin{equation}
    \alpha^{n}_{2} v^{n}_{2} + \gamma^{n}_{2} v^{n}_{3} = b_2 v^{n+1}_{1} + a_2 v^{n+1}_{2} + c_2 v^{n+1}_{3} + d^{n+1}_{2}\bar{S}^{n} - \beta^{n}_{2} (K - (1+\Delta x)\bar{S}^n) 
\end{equation}

\begin{equation}
    \beta^{n}_{M} v^{n}_{M-1} + \alpha^{n}_{M} v^{n}_{M} = b_i v^{n+1}_{i-1} + a_i v^{n+1}_{i} + c_i v^{n+1}_{i+1} + d^{n+1}_{i}\bar{S}^{n}
\end{equation}
